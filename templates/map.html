<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LineAgeMap • Map</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body class="landing">

  <!-- OLD HEADER (matches your screenshot header) -->
  <header class="oldbar">
    <div class="oldbar-inner">

      <a class="oldbar-brand" href="{{ url_for('index') }}" aria-label="LineAgeMap Home">
        <div class="oldbar-brand-title">LineAgeMap</div>
        <div class="oldbar-brand-sub">Where your family's story took shape</div>
      </a>

      <div class="oldbar-center">
        <div class="choose-pill" aria-label="Current tree">
          <span class="choose-pill-text">GUPTA FAMILY TREE</span>
        </div>
      </div>

      <div class="oldbar-right">
        <a class="oldbar-iconbtn" href="{{ url_for('index') }}" aria-label="Home" title="Home">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path d="M3 10.5 12 3l9 7.5"></path>
            <path d="M6.5 10.5V21h11V10.5"></path>
          </svg>
        </a>

        <div class="oldbar-logo" aria-label="LineAgeMap logo" title="LineAgeMap">
          <svg viewBox="0 0 64 64" aria-hidden="true">
            <path d="M32 56V30" />
            <path d="M32 30c-9 0-16-7-16-16S23 6 32 6s16 8 16 8-7 16-16 16Z" />
            <circle cx="20" cy="20" r="4" />
            <circle cx="44" cy="20" r="4" />
            <circle cx="26" cy="36" r="4" />
            <circle cx="38" cy="36" r="4" />
          </svg>
        </div>
      </div>

    </div>
  </header>

  <!-- MAP PANEL -->
  <main class="map-shell">
    <section class="map-panel">
      <div class="map-canvas" id="mapCanvas" aria-label="Family map">
        <img
          class="map-bg"
          src="{{ url_for('static', filename='img/world-muted.png') }}"
          alt=""
          aria-hidden="true"
        />
        <div class="map-pins" id="mapPins"></div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="footer-inner">
      <div>
        <div class="footer-brand">LineAgeMap</div>
        <div class="footer-note">Simple. Nostalgic. Shareable.</div>
        <div class="footer-copy">© 2026</div>
      </div>
    </div>
  </footer>

  <script>
    // Which family file to load (matches /api/tree/<name>)
    const FAMILY_NAME = "gupta";

    // Projection:
    // x = (lng + 180) / 360 * width
    // y = (90 - lat) / 180 * height
    function project(lat, lng, width, height) {
      const x = (lng + 180) / 360 * width;
      const y = (90 - lat) / 180 * height;
      return { x, y };
    }

    function parseYear(val) {
      if (val == null) return null;
      const n = parseInt(String(val).trim(), 10);
      return Number.isFinite(n) ? n : null;
    }

    function calcAge(bornStr, diedStr) {
      const born = parseYear(bornStr);
      if (!born) return null;

      const died = parseYear(diedStr);
      const nowYear = new Date().getFullYear();
      const end = died || nowYear;

      const age = end - born;
      return (age >= 0 && age <= 130) ? age : null;
    }

    function safeText(v) {
      return (v ?? "").toString();
    }

    function buildPin(person) {
      const current = person.current || null;
      if (!current || current.lat == null || current.lng == null) return null;

      const age = calcAge(person.born, person.died);
      const name = safeText(person.name);
      const city = safeText(current.city);

      const el = document.createElement("div");
      el.className = "avatar-pin";

      const img = document.createElement("img");
      img.className = "avatar-pin-img";
      img.alt = name;
      img.src = person.photo || "{{ url_for('static', filename='img/placeholder-avatar.png') }}";

      const label = document.createElement("div");
      label.className = "avatar-pin-label";

      const top = document.createElement("div");
      top.className = "avatar-pin-name";
      top.textContent = age != null ? `${name} • ${age}` : name;

      const bottom = document.createElement("div");
      bottom.className = "avatar-pin-city";
      bottom.textContent = city || "—";

      label.appendChild(top);
      label.appendChild(bottom);

      el.appendChild(img);
      el.appendChild(label);

      return { el, lat: current.lat, lng: current.lng, key: `${current.lat},${current.lng}` };
    }

    // Keep pins from going off the edges (accounts for avatar + label)
    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    async function initMapPins() {
      const canvas = document.getElementById("mapCanvas");
      const pinsLayer = document.getElementById("mapPins");

      const res = await fetch(`/api/tree/${FAMILY_NAME}`);
      const data = await res.json();
      const people = Array.isArray(data.people) ? data.people : [];

      // Build pins
      const pins = [];
      for (const p of people) {
        const pin = buildPin(p);
        if (pin) pins.push(pin);
      }

      // Group pins with identical coordinates so they don't stack
      const groups = new Map();
      for (const pin of pins) {
        const arr = groups.get(pin.key) || [];
        arr.push(pin);
        groups.set(pin.key, arr);
      }

      function layout() {
        pinsLayer.innerHTML = "";

        const rect = canvas.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        // padding so pins stay visible
        const padLeftRight = 120; // room for label box
        const padTopBottom = 60;  // room for avatar

        // place each group in a tiny ring
        for (const [key, arr] of groups.entries()) {
          const first = arr[0];
          const base = project(first.lat, first.lng, w, h);

          const n = arr.length;
          const radius = n === 1 ? 0 : 18; // spacing between stacked people

          for (let i = 0; i < n; i++) {
            const pin = arr[i];
            const node = pin.el;

            // offset pins in a circle if multiple share same coords
            const angle = (i / Math.max(1, n)) * Math.PI * 2;
            const dx = Math.cos(angle) * radius;
            const dy = Math.sin(angle) * radius;

            let x = base.x + dx;
            let y = base.y + dy;

            // clamp into visible bounds
            x = clamp(x, padLeftRight, w - padLeftRight);
            y = clamp(y, padTopBottom, h - padTopBottom);

            node.style.left = `${x}px`;
            node.style.top = `${y}px`;

            pinsLayer.appendChild(node);
          }
        }
      }

      layout();
      window.addEventListener("resize", layout);
    }

    initMapPins().catch(console.error);
  </script>

</body>
</html>